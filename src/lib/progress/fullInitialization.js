// Inicializaci√≥n completa del sistema de progreso y anal√≠ticas

import {
  initProgressSystem,
  isProgressSystemInitialized,
  getCurrentUserId
} from './index.js'

import {
  initDB,
  initTracking,
  initializeVerbs,
  initializeItems
} from './all.js'

import { createLogger } from '../utils/logger.js'

const logger = createLogger('progress:fullInit')

// Estado de inicializaci√≥n completa
let isFullyInitialized = false

/**
 * Inicializa completamente el sistema de progreso y anal√≠ticas
 * @param {string} userId - ID del usuario (si no se proporciona, se genera uno)
 * @returns {Promise<string>} ID del usuario
 */
export async function initializeFullProgressSystem(userId = null) {
  logger.info('initializeFullProgressSystem', 'üöÄ Inicializando completamente el sistema de progreso y anal√≠ticas...')

  try {
    // Si ya est√° completamente inicializado, devolver el ID actual
    if (isFullyInitialized && getCurrentUserId()) {
      logger.info('initializeFullProgressSystem', `‚úÖ Sistema ya completamente inicializado para usuario ${getCurrentUserId()}`)
      return getCurrentUserId()
    }

    // Inicializar sistema b√°sico
    const initializedUserId = await initProgressSystem(userId)
    logger.info('initializeFullProgressSystem', `‚úÖ Sistema b√°sico inicializado para usuario ${initializedUserId}`)

    // Inicializar base de datos
    await initDB()
    logger.info('initializeFullProgressSystem', '‚úÖ Base de datos inicializada')

    // Inicializar tracking
    await initTracking(initializedUserId)
    logger.info('initializeFullProgressSystem', '‚úÖ Tracking inicializado')

    // Inicializar verbos
    await initializeVerbs()
    logger.info('initializeFullProgressSystem', '‚úÖ Verbos inicializados')

    // Inicializar √≠tems
    await initializeItems()
    logger.info('initializeFullProgressSystem', '‚úÖ √çtems inicializados')

    // Marcar como completamente inicializado
    isFullyInitialized = true

    logger.info('initializeFullProgressSystem', `üéâ Sistema de progreso y anal√≠ticas completamente inicializado para usuario ${initializedUserId}`)
    return initializedUserId
  } catch (error) {
    logger.error('initializeFullProgressSystem', '‚ùå Error al inicializar completamente el sistema de progreso y anal√≠ticas', error)
    throw error
  }
}

/**
 * Verifica si el sistema est√° completamente inicializado
 * @returns {boolean} Si el sistema est√° completamente inicializado
 */
export function isFullProgressSystemInitialized() {
  return isFullyInitialized && isProgressSystemInitialized()
}

/**
 * Reinicia la inicializaci√≥n completa
 * @returns {Promise<void>}
 */
export async function resetFullInitialization() {
  logger.info('resetFullInitialization', 'üîÑ Reiniciando inicializaci√≥n completa...')

  try {
    // Reiniciar estado
    isFullyInitialized = false

    logger.info('resetFullInitialization', '‚úÖ Inicializaci√≥n completa reiniciada')
  } catch (error) {
    logger.error('resetFullInitialization', '‚ùå Error al reiniciar inicializaci√≥n completa', error)
    throw error
  }
}

/**
 * Verifica el estado de la inicializaci√≥n completa
 * @returns {Object} Estado de la inicializaci√≥n
 */
export function getFullInitializationStatus() {
  return {
    isInitialized: isFullProgressSystemInitialized(),
    userId: getCurrentUserId(),
    components: {
      basic: isProgressSystemInitialized(),
      database: true, // En una implementaci√≥n completa, esto verificar√≠a el estado real
      tracking: true, // En una implementaci√≥n completa, esto verificar√≠a el estado real
      verbs: true, // En una implementaci√≥n completa, esto verificar√≠a el estado real
      items: true // En una implementaci√≥n completa, esto verificar√≠a el estado real
    }
  }
}

/**
 * Ejecuta un diagn√≥stico de la inicializaci√≥n completa
 * @returns {Promise<Object>} Resultados del diagn√≥stico
 */
export async function diagnoseFullInitialization() {
  logger.info('diagnoseFullInitialization', 'üîç Diagnosticando inicializaci√≥n completa...')

  try {
    const status = getFullInitializationStatus()

    // Verificar cada componente
    const diagnostics = {
      basic: status.components.basic ? '‚úÖ' : '‚ùå',
      database: status.components.database ? '‚úÖ' : '‚ùå',
      tracking: status.components.tracking ? '‚úÖ' : '‚ùå',
      verbs: status.components.verbs ? '‚úÖ' : '‚ùå',
      items: status.components.items ? '‚úÖ' : '‚ùå'
    }

    const allGood = Object.values(diagnostics).every(d => d === '‚úÖ')

    logger.info('diagnoseFullInitialization', `üìä Diagn√≥stico de inicializaci√≥n completa: ${allGood ? '‚úÖ' : '‚ùå'}`)
    Object.entries(diagnostics).forEach(([component, status]) => {
      logger.debug('diagnoseFullInitialization', `  ${status} ${component}`)
    })

    return {
      status: allGood ? 'healthy' : 'issues',
      diagnostics,
      userId: status.userId,
      timestamp: new Date()
    }
  } catch (error) {
    logger.error('diagnoseFullInitialization', '‚ùå Error al diagnosticar inicializaci√≥n completa', error)
    return {
      status: 'error',
      error: error.message,
      timestamp: new Date()
    }
  }
}

/**
 * Ejecuta pruebas de la inicializaci√≥n completa
 * @returns {Promise<Object>} Resultados de las pruebas
 */
export async function testFullInitialization() {
  logger.info('testFullInitialization', 'üß™ Ejecutando pruebas de inicializaci√≥n completa...')

  try {
    // Verificar que todas las funciones est√°n disponibles
    const functions = [
      initProgressSystem,
      isProgressSystemInitialized,
      getCurrentUserId,
      initDB,
      initTracking,
      initializeVerbs,
      initializeItems
    ]

    const allFunctionsAvailable = functions.every(fn => typeof fn === 'function')

    // Verificar inicializaci√≥n
    const userId = await initializeFullProgressSystem()
    const isInitialized = isFullProgressSystemInitialized()
    const status = getFullInitializationStatus()
    const diagnosis = await diagnoseFullInitialization()

    const allTestsPassed = allFunctionsAvailable && isInitialized && status.isInitialized && diagnosis.status === 'healthy'

    logger.info('testFullInitialization', `üß™ Pruebas de inicializaci√≥n completa: ${allTestsPassed ? '‚úÖ' : '‚ùå'}`)
    logger.debug('testFullInitialization', `  ${allFunctionsAvailable ? '‚úÖ' : '‚ùå'} Todas las funciones disponibles`)
    logger.debug('testFullInitialization', `  ${isInitialized ? '‚úÖ' : '‚ùå'} Sistema completamente inicializado`)
    logger.debug('testFullInitialization', `  ${status.isInitialized ? '‚úÖ' : '‚ùå'} Estado de inicializaci√≥n correcto`)
    logger.debug('testFullInitialization', `  ${diagnosis.status === 'healthy' ? '‚úÖ' : '‚ùå'} Diagn√≥stico saludable`)

    return {
      passed: allTestsPassed,
      functions: allFunctionsAvailable,
      initialized: isInitialized,
      status: status.isInitialized,
      diagnosis: diagnosis.status === 'healthy',
      userId,
      timestamp: new Date()
    }
  } catch (error) {
    logger.error('testFullInitialization', '‚ùå Error al ejecutar pruebas de inicializaci√≥n completa', error)
    return {
      passed: false,
      error: error.message,
      timestamp: new Date()
    }
  }
}

// Ejecutar inicializaci√≥n completa si este archivo se ejecuta directamente
if (typeof window !== 'undefined' && window.location) {
  // Solo ejecutar en el navegador
  // DISABLED: initializeFullProgressSystem().catch(error => {
  //   logger.error('auto-init', 'Error en inicializaci√≥n completa', error)
  // })
  logger.info('auto-init', '‚è∏Ô∏è Inicializaci√≥n completa autom√°tica deshabilitada temporalmente')
}

export default {
  initializeFullProgressSystem,
  isFullProgressSystemInitialized,
  resetFullInitialization,
  getFullInitializationStatus,
  diagnoseFullInitialization,
  testFullInitialization
}